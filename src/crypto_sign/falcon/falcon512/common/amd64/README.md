code that is shared between avx2 and ref
